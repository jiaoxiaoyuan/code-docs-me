<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP3 | Mr焦</title>
    <meta name="description" content="此个人博客是一个专注于IT技术学习交流的个人技术博客网站,包括敏捷开发、自动化测试、网站开发、服务器运维等领域，创建该个人博客也是为了方便与志同道合的朋友一起互相学习交流，分享经验，感谢大家的支持。">
    <meta name="generator" content="VitePress v1.2.3">
    <link rel="preload stylesheet" href="/assets/style.BtGpIn2I.css" as="style">
    
    <script type="module" src="/assets/app.a7ar90jf.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.BLn97x5X.js">
    <link rel="modulepreload" href="/assets/chunks/theme.k8NDJ5m1.js">
    <link rel="modulepreload" href="/assets/KnowledgeBase_FrontEnd_JavaScript_computer-networks_http_http3.md.B7hcUyFV.lean.js">
    <meta name="keywords" content="知识库, 个人博客,个人网站,个人主页,IT博客,技术博客,程序员博客个人博客,个人网站,个人主页,IT博客,技术博客,程序员博客">
    <meta name="author" content="Jixiaoyuan">
    <link rel="icon" href="https://img.mtsws.cn/LightPicture/2023/08/8b794e021120837b.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta name="baidu-site-verification" content="codeva-YylYjOSjF2">
    <meta name="google-site-verification" content="9PfpWj_9VHtKGmyidDyvMGWZT3DujZ6Re0QoaaDkrD8">
    <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?2dff25399b2114fbc4f60b9edb1c28aa";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><!--[--><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar top" data-v-ae24b3ad data-v-ccf7ddec><div class="wrapper" data-v-ccf7ddec><div class="container" data-v-ccf7ddec><div class="title" data-v-ccf7ddec><div class="VPNavBarTitle" data-v-ccf7ddec data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="https://img.mtsws.cn/LightPicture/2023/08/8b794e021120837b.png" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>Mr焦</span><!--[--><!--]--></a></div></div><div class="content" data-v-ccf7ddec><div class="content-body" data-v-ccf7ddec><!--[--><!--]--><div class="VPNavBarSearch search" data-v-ccf7ddec><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-ccf7ddec data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-ccf7ddec data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ccf7ddec data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-ccf7ddec><div class="divider-line" data-v-ccf7ddec></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>返回顶部</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>当前页大纲</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _KnowledgeBase_FrontEnd_JavaScript_computer-networks_http_http3" data-v-39a288b8><div><h1 id="http3" tabindex="-1">HTTP3 <a class="header-anchor" href="#http3" aria-label="Permalink to &quot;HTTP3&quot;">​</a></h1><h2 id="http-发展历史" tabindex="-1">HTTP 发展历史 <a class="header-anchor" href="#http-发展历史" aria-label="Permalink to &quot;HTTP 发展历史&quot;">​</a></h2><ul><li>HTTP/0.9 - 1991 单行协议：只支持 GET 方法；没有首部；只能获取纯文本</li><li>HTTP/1.0 - 1996 搭建协议框架：增加了首部、状态码、权限、缓存、长连接（默认短连接）等规范</li><li>HTTP/1.1 - 1997 默认长连接；缓存字段扩展；强制客户端提供 Host 首部；管线化 <ul><li>SPDY - 2012 强制压缩、多路复用、Pipeling、双向通信、优先级调用</li></ul></li><li>HTTP/2 - 2015 头部压缩、多路复用、Pipelining、Server push（解决 HTTP 队首阻塞）</li><li>HTTP/3 - 2018 快速握手、可靠传输、有序交付（解决 TCP 队首阻塞）</li></ul><br><table tabindex="0"><thead><tr><th style="text-align:left;">应用层</th><th style="text-align:left;">传输层</th><th style="text-align:left;">网络层</th></tr></thead><tbody><tr><td style="text-align:left;">HTTP</td><td style="text-align:left;">TCP</td><td style="text-align:left;">IP</td></tr><tr><td style="text-align:left;">HTTP/2 + TLS/1.2+</td><td style="text-align:left;">TCP</td><td style="text-align:left;">IP</td></tr><tr><td style="text-align:left;">HTTP/3 + TLS/1.3</td><td style="text-align:left;">QUIC（UDP）</td><td style="text-align:left;">IP</td></tr></tbody></table><br><ul><li>🗑 <s>TLS1.1- 由于安全因素，已经或将要废弃</s></li><li>TLS 1.2 当今的主流版本</li><li>TLS 1.3 简化了握手流程，增强了安全性</li></ul><h2 id="旧版本存在问题" tabindex="-1">旧版本存在问题 <a class="header-anchor" href="#旧版本存在问题" aria-label="Permalink to &quot;旧版本存在问题&quot;">​</a></h2><p>虽然 HTTP/2 解决了很多之前旧版本的问题，但是它还是存在一个巨大的问题，主要是底层支撑的 TCP 协议造成的。HTTP/2 的缺点主要有以下两点：</p><ul><li><strong>建立连接的延时</strong>：HTTP/2 使用 TCP 协议来传输的，而如果使用 HTTPS 的话，还需要使用 TLS 协议进行安全传输，而使用 TLS 也需要一个握手过程，<strong>这样就需要有两个握手延迟过程</strong></li><li><strong>队头阻塞并没有彻底解决</strong>：在 HTTP/2 中，多个请求是跑在一个 TCP 管道中的。但当出现了丢包时，HTTP/2 的表现反倒不如 HTTP/1 了。因为 TCP 为了保证可靠传输，有个 <strong>丢包重传</strong> 机制，丢失的包必须要等待重新传输确认，HTTP/2 出现丢包时，整个 TCP 都要开始等待重传，那么就会阻塞该 TCP 连接中的所有请求。而对于 HTTP/1.1 来说，可以开启多个 TCP 连接，出现这种情况反到只会影响其中一个连接，剩余的 TCP 连接还可以正常传输数据</li></ul><h2 id="http3-简介" tabindex="-1">HTTP3 简介 <a class="header-anchor" href="#http3-简介" aria-label="Permalink to &quot;HTTP3 简介&quot;">​</a></h2><p>Google 在推 SPDY 的时候就已经意识到了这些问题，于是就另起炉灶搞了一个基于 UDP 协议的“QUIC”协议，让 HTTP 跑在 QUIC 上而不是 TCP 上。 而这个“HTTP over QUIC”就是 HTTP 协议的下一个大版本，HTTP/3。</p><div class="language-jsx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> React </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;react&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> img </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../../assets/http3/quic.png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">img</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> alt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;QUIC 协议&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> src</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{img} </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">640</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} /&gt;;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>QUIC 虽然基于 UDP，但是在原本的基础上新增了很多功能，接下来我们重点介绍几个 QUIC 新功能。不过 HTTP/3 目前还处于草案阶段，正式发布前可能会有变动，所以本文尽量不涉及那些不稳定的细节。</p><h2 id="新特性" tabindex="-1">新特性 <a class="header-anchor" href="#新特性" aria-label="Permalink to &quot;新特性&quot;">​</a></h2><h3 id="零-rtt-建立连接" tabindex="-1">零 RTT 建立连接 <a class="header-anchor" href="#零-rtt-建立连接" aria-label="Permalink to &quot;零 RTT 建立连接&quot;">​</a></h3><p>HTTP/2 的连接需要 3 RTT，如果考虑会话复用，即把第一次握手算出来的对称密钥缓存起来，那么也需要 2 RTT，更进一步的，如果 TLS 升级到 1.3，那么 HTTP/2 连接需要 2 RTT，考虑会话复用则需要 1 RTT。</p><p>有人会说 HTTP/2 不一定需要 HTTPS，握手过程还可以简化。这没毛病，HTTP/2 的标准的确不需要基于 HTTPS，但实际上所有浏览器的实现都要求 HTTP/2 必须基于 HTTPS，所以 HTTP/2 的加密连接必不可少。</p><p>而 HTTP/3 首次连接只需要 1 RTT，后面的连接更是只需 0 RTT，意味着客户端发给服务端的第一个包就带有请求数据，这一点 HTTP/2 难以望其项背。那这背后是什么原理呢？我们具体看下 QUIC 的连接过程。</p><ol><li>首次连接时，客户端发送 Inchoate Client Hello 给服务端，用于请求连接；</li><li>服务端生成 g、p、a，根据 g、p 和 a 算出 A，然后将 g、p、A 放到 Server Config 中再发送 Rejection 消息给客户端；</li><li>客户端接收到 g、p、A 后，自己再生成 b，根据 g、p、b 算出 B，根据 A、p、b 算出初始密钥 K。B 和 K 算好后，客户端会用 K 加密 HTTP 数据，连同 B 一起发送给服务端；</li><li>服务端接收到 B 后，根据 a、p、B 生成与客户端同样的密钥，再用这密钥解密收到的 HTTP 数据。为了进一步的安全（前向安全性），服务端会更新自己的随机数 a 和公钥，再生成新的密钥 S，然后把公钥通过 Server Hello 发送给客户端。连同 Server Hello 消息，还有 HTTP 返回数据；</li><li>客户端收到 Server Hello 后，生成与服务端一致的新密钥 S，后面的传输都使用 S 加密。</li></ol><p>这样，QUIC 从请求连接到正式接发 HTTP 数据一共花了 1 RTT，这 1 个 RTT 主要是为了获取 Server Config，后面的连接如果客户端缓存了 Server Config，那么就可以直接发送 HTTP 数据，实现 0 RTT 建立连接。</p><p>这里使用的是 DH 密钥交换算法，DH 算法的核心就是服务端生成 a、g、p 3 个随机数，a 自己持有，g 和 p 要传输给客户端，而客户端会生成 b 这 1 个随机数，通过 DH 算法客户端和服务端可以算出同样的密钥。在这过程中 a 和 b 并不参与网络传输，安全性大大提高。因为 p 和 g 是大数，所以即使在网络中传输的 p、g、A、B 都被劫持，那么靠现在的计算机算力也没法破解密钥。</p><h3 id="连接迁移" tabindex="-1">连接迁移 <a class="header-anchor" href="#连接迁移" aria-label="Permalink to &quot;连接迁移&quot;">​</a></h3><p>TCP 连接基于四元组（源 IP、源端口、目的 IP、目的端口），切换网络时至少会有一个因素发生变化，导致连接发生变化。当连接发生变化时，如果还使用原来的 TCP 连接，则会导致连接失败，就得等原来的连接超时后重新建立连接，所以我们有时候发现切换到一个新网络时，即使新网络状况良好，但内容还是需要加载很久。如果实现得好，当检测到网络变化时立刻建立新的 TCP 连接，即使这样，建立新的连接还是需要几百毫秒的时间。</p><p>QUIC 的连接不受四元组的影响，当这四个元素发生变化时，原连接依然维持。那这是怎么做到的呢？道理很简单，QUIC 连接不以四元组作为标识，而是使用一个 64 位的随机数，这个随机数被称为 Connection ID，即使 IP 或者端口发生变化，只要 Connection ID 没有变化，那么连接依然可以维持。</p><h3 id="队头阻塞和多路复用" tabindex="-1">队头阻塞和多路复用 <a class="header-anchor" href="#队头阻塞和多路复用" aria-label="Permalink to &quot;队头阻塞和多路复用&quot;">​</a></h3><p>队头阻塞会导致 HTTP/2 在更容易丢包的弱网络环境下比 HTTP/1.1 更慢！</p><p>那 QUIC 是如何解决队头阻塞问题的呢？主要有两点。</p><ul><li>QUIC 的传输单元是 Packet，加密单元也是 Packet，整个加密、传输、解密都基于 Packet，这样就能避免 TLS 的队头阻塞问题</li><li>QUIC 基于 UDP，UDP 的数据包在接收端没有处理顺序，即使中间丢失一个包，也不会阻塞整条连接，其他的资源会被正常处理</li></ul><h3 id="拥塞控制" tabindex="-1">拥塞控制 <a class="header-anchor" href="#拥塞控制" aria-label="Permalink to &quot;拥塞控制&quot;">​</a></h3><p>拥塞控制的目的是避免过多的数据一下子涌入网络，导致网络超出最大负荷。QUIC 的拥塞控制与 TCP 类似，并在此基础上做了改进。所以我们先简单介绍下 TCP 的拥塞控制。</p><p>TCP 拥塞控制由 4 个核心算法组成：慢启动、拥塞避免、快速重传和快速恢复，理解了这 4 个算法，对 TCP 的拥塞控制也就有了大概了解。</p><ul><li><strong>慢启动</strong>：发送方向接收方发送 1 个单位的数据，收到对方确认后会发送 2 个单位的数据，然后依次是 4 个、8 个……呈指数级增长，这个过程就是在不断试探网络的拥塞程度，超出阈值则会导致网络拥塞；</li><li><strong>拥塞避免</strong>：指数增长不可能是无限的，到达某个限制（慢启动阈值）之后，指数增长变为线性增长；</li><li><strong>快速重传</strong>：发送方每一次发送时都会设置一个超时计时器，超时后即认为丢失，需要重发；</li><li><strong>快速恢复</strong>：在上面快速重传的基础上，发送方重新发送数据时，也会启动一个超时定时器，如果收到确认消息则进入拥塞避免阶段，如果仍然超时，则回到慢启动阶段。</li></ul><p>QUIC 重新实现了 TCP 协议的 Cubic 算法进行拥塞控制，并在此基础上做了不少改进。下面介绍一些 QUIC 改进的拥塞控制的特性。</p><h4 id="热插拔" tabindex="-1">热插拔 <a class="header-anchor" href="#热插拔" aria-label="Permalink to &quot;热插拔&quot;">​</a></h4><p>TCP 中如果要修改拥塞控制策略，需要在系统层面进行操作。QUIC 修改拥塞控制策略只需要在应用层操作，并且 QUIC 会根据不同的网络环境、用户来动态选择拥塞控制算法。</p><h4 id="前向纠错-fec" tabindex="-1">前向纠错 FEC <a class="header-anchor" href="#前向纠错-fec" aria-label="Permalink to &quot;前向纠错 FEC&quot;">​</a></h4><p>QUIC 使用前向纠错（FEC，Forward Error Correction）技术增加协议的容错性。一段数据被切分为 10 个包后，依次对每个包进行异或运算，运算结果会作为 FEC 包与数据包一起被传输，如果不幸在传输过程中有一个数据包丢失，那么就可以根据剩余 9 个包以及 FEC 包推算出丢失的那个包的数据，这样就大大增加了协议的容错性。</p><p>这是符合现阶段网络技术的一种方案，现阶段带宽已经不是网络传输的瓶颈，往返时间才是，所以新的网络传输协议可以适当增加数据冗余，减少重传操作。</p><h4 id="单调递增的-packet-number" tabindex="-1">单调递增的 Packet Number <a class="header-anchor" href="#单调递增的-packet-number" aria-label="Permalink to &quot;单调递增的 Packet Number&quot;">​</a></h4><p>TCP 为了保证可靠性，使用 Sequence Number 和 ACK 来确认消息是否有序到达，但这样的设计存在缺陷。</p><p>超时发生后客户端发起重传，后来接收到了 ACK 确认消息，但因为原始请求和重传请求接收到的 ACK 消息一样，所以客户端就郁闷了，不知道这个 ACK 对应的是原始请求还是重传请求。如果客户端认为是原始请求的 ACK，但实际上是左图的情形，则计算的采样 RTT 偏大；如果客户端认为是重传请求的 ACK，但实际上是右图的情形，又会导致采样 RTT 偏小。图中有几个术语，RTO 是指超时重传时间（Retransmission TimeOut），跟我们熟悉的 RTT（Round Trip Time，往返时间）很长得很像。采样 RTT 会影响 RTO 计算，超时时间的准确把握很重要，长了短了都不合适。</p><p>QUIC 解决了上面的歧义问题。与 Sequence Number 不同的是，Packet Number 严格单调递增，如果 Packet N 丢失了，那么重传时 Packet 的标识不会是 N，而是比 N 大的数字，比如 N + M，这样发送方接收到确认消息时就能方便地知道 ACK 对应的是原始请求还是重传请求。</p><h4 id="ack-delay" tabindex="-1">ACK Delay <a class="header-anchor" href="#ack-delay" aria-label="Permalink to &quot;ACK Delay&quot;">​</a></h4><p>TCP 计算 RTT 时没有考虑接收方接收到数据到发送确认消息之间的延迟，如下图所示，这段延迟即 ACK Delay。QUIC 考虑了这段延迟，使得 RTT 的计算更加准确。</p><h4 id="更多的-ack-块" tabindex="-1">更多的 ACK 块 <a class="header-anchor" href="#更多的-ack-块" aria-label="Permalink to &quot;更多的 ACK 块&quot;">​</a></h4><p>一般来说，接收方收到发送方的消息后都应该发送一个 ACK 回复，表示收到了数据。但每收到一个数据就返回一个 ACK 回复太麻烦，所以一般不会立即回复，而是接收到多个数据后再回复，TCP SACK 最多提供 3 个 ACK block。但有些场景下，比如下载，只需要服务器返回数据就好，但按照 TCP 的设计，每收到 3 个数据包就要“礼貌性”地返回一个 ACK。而 QUIC 最多可以捎带 256 个 ACK block。在丢包率比较严重的网络下，更多的 ACK block 可以减少重传量，提升网络效率。</p><h3 id="流量控制" tabindex="-1">流量控制 <a class="header-anchor" href="#流量控制" aria-label="Permalink to &quot;流量控制&quot;">​</a></h3><p>TCP 会对每个 TCP 连接进行流量控制，流量控制的意思是让发送方不要发送太快，要让接收方来得及接收，不然会导致数据溢出而丢失，TCP 的流量控制主要通过滑动窗口来实现的。可以看出，拥塞控制主要是控制发送方的发送策略，但没有考虑到接收方的接收能力，流量控制是对这部分能力的补齐。</p><p>QUIC 只需要建立一条连接，在这条连接上同时传输多条 Stream，好比有一条道路，两头分别有一个仓库，道路中有很多车辆运送物资。QUIC 的流量控制有两个级别：连接级别（Connection Level）和 Stream 级别（Stream Level），好比既要控制这条路的总流量，不要一下子很多车辆涌进来，货物来不及处理，也不能一个车辆一下子运送很多货物，这样货物也来不及处理。</p><p>那 QUIC 是怎么实现流量控制的呢？我们先看单条 Stream 的流量控制。Stream 还没传输数据时，接收窗口（flow control receive window）就是最大接收窗口（flow control receive window），随着接收方接收到数据后，接收窗口不断缩小。在接收到的数据中，有的数据已被处理，而有的数据还没来得及被处理。如下图所示，蓝色块表示已处理数据，黄色块表示未处理数据，这部分数据的到来，使得 Stream 的接收窗口缩小。</p><p>随着数据不断被处理，接收方就有能力处理更多数据。当满足 (flow control receive offset - consumed bytes) &lt; (max receive window / 2) 时，接收方会发送 WINDOW_UPDATE frame 告诉发送方你可以再多发送些数据过来。这时 flow control receive offset 就会偏移，接收窗口增大，发送方可以发送更多数据到接收方。</p><p>Stream 级别对防止接收端接收过多数据作用有限，更需要借助 Connection 级别的流量控制。理解了 Stream 流量那么也很好理解 Connection 流控。Stream 中，接收窗口(flow control receive window) = 最大接收窗口(max receive window) - 已接收数据(highest received byte offset) ，而对 Connection 来说：接收窗口 = Stream1 接收窗口 + Stream2 接收窗口 + ... + StreamN 接收窗口 。</p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><ul><li><a href="https://mp.weixin.qq.com/s/MHYMOYHqhrAbQ0xtTkV2ig" target="_blank" rel="noreferrer">HTTP/3 原理实战</a></li></ul></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-d4a0bba5><!--[--><!--]--><div class="edit-info" data-v-d4a0bba5><div class="edit-link" data-v-d4a0bba5><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/jiaoxiaoyuan/code-docs-me/edit/master/docs/KnowledgeBase/FrontEnd/JavaScript/computer-networks/http/http3.md" target="_blank" rel="noreferrer" data-v-d4a0bba5><!--[--><span class="vpi-square-pen edit-link-icon" data-v-d4a0bba5></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-d4a0bba5><p class="VPLastUpdated" data-v-d4a0bba5 data-v-7e05ebdb>最后更新于: <time datetime="2024-06-30T10:15:20.000Z" data-v-7e05ebdb></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><footer class="VPFooter" data-v-768014fb><div class="container" data-v-768014fb><p class="recordCode" data-v-768014fb><span class="icon" data-v-768014fb><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" data-v-768014fb><title data-v-768014fb>ICP备案号</title><path d="M778.24 163.84c-76.8-40.96-165.888-61.44-269.312-61.44s-192.512 20.48-269.312 61.44h-133.12l23.552 337.92c8.192 113.664 67.584 217.088 162.816 280.576l215.04 144.384 215.04-144.384c96.256-63.488 155.648-166.912 163.84-280.576l23.552-337.92H778.24z m47.104 333.824c-7.168 94.208-56.32 181.248-135.168 233.472l-181.248 120.832L327.68 731.136c-78.848-53.248-129.024-139.264-135.168-233.472L173.056 225.28h136.192v-26.624c58.368-23.552 124.928-34.816 199.68-34.816s141.312 12.288 199.68 34.816V225.28H844.8l-19.456 272.384z" data-v-768014fb></path><path d="M685.056 328.704v-46.08H455.68c2.048-4.096 6.144-9.216 11.264-15.36 5.12-7.168 9.216-12.288 11.264-15.36L419.84 240.64c-31.744 46.08-75.776 87.04-133.12 123.904 4.096 4.096 10.24 11.264 18.432 21.504l17.408 17.408c23.552-15.36 45.056-31.744 63.488-50.176 26.624 25.6 49.152 43.008 67.584 51.2-46.08 15.36-104.448 27.648-175.104 35.84 2.048 5.12 6.144 13.312 9.216 24.576 4.096 11.264 6.144 19.456 7.168 24.576l39.936-7.168v218.112H389.12V680.96h238.592v19.456h54.272V481.28H348.16c60.416-12.288 114.688-27.648 163.84-46.08 49.152 19.456 118.784 34.816 210.944 46.08 5.12-17.408 10.24-34.816 17.408-51.2-62.464-4.096-116.736-12.288-161.792-24.576 38.912-20.48 74.752-46.08 106.496-76.8z m-150.528 194.56h94.208v41.984h-94.208v-41.984z m0 78.848h94.208v41.984h-94.208v-41.984z m-144.384-78.848h94.208v41.984H390.144v-41.984z m0 78.848h94.208v41.984H390.144v-41.984zM424.96 326.656h182.272c-26.624 22.528-57.344 41.984-94.208 57.344-31.744-15.36-61.44-34.816-88.064-57.344z" data-v-768014fb></path></svg></span><span class="content" data-v-768014fb><a href="https://beian.miit.gov.cn" target="_blank" data-v-768014fb>蜀ICP备17037090号-4</a></span></p><p class="recordCode" data-v-768014fb><span class="icon" data-v-768014fb><img src="https://beian.mps.gov.cn/web/assets/logo01.6189a29f.png" title="联网备案号" data-v-768014fb></span><span class="content" data-v-768014fb><a href="&#39;https://beian.mps.gov.cn/#/query/webSearch" target="_blank" data-v-768014fb>渝公网安备50010702505709号</a></span></p><p class="copyright" data-v-768014fb>Copyright © 2024 我的编程日志 版权所有</p></div></footer><!--]--></div><!----><!--]--></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blog_index.md\":\"C6l8Tmj6\",\"knowledgebase_frontend_css_concept_attribute_index.md\":\"BUXpj6m6\",\"knowledgebase_backend_java_index.md\":\"BtnaNazT\",\"knowledgebase_backend_python_basics_测试.md\":\"BT7gEUVA\",\"knowledgebase_backend_index.md\":\"B-XVBKAU\",\"knowledgebase_backend_python_index.md\":\"yWml6-0K\",\"essay_index.md\":\"Cai77J0I\",\"about_index.md\":\"DwB3o4_q\",\"knowledgebase_frontend_css_concept_concept_优先级.md\":\"Bb6yMNi6\",\"blog_index1.md\":\"DaLTpb7g\",\"knowledgebase_algorithm_index.md\":\"D5Gij4nD\",\"knowledgebase_frontend_css_application_实现水平垂直居中最便捷的方法.md\":\"BMf5vvCe\",\"knowledgebase_backend_python_advanced_测试.md\":\"o-GEHtio\",\"knowledgebase_frontend_html_attribute_index2.md\":\"Bf5hHlnd\",\"knowledgebase_frontend_html_resources_index4.md\":\"DUNyumsf\",\"knowledgebase_frontend_html_concept_index2.md\":\"1mOLL8UU\",\"knowledgebase_frontend_html_resources_index5.md\":\"CoRFxw3F\",\"knowledgebase_frontend_html_resources_index3.md\":\"Cp-wbAD4\",\"knowledgebase_frontend_html_resources_index2.md\":\"D1jQJb3K\",\"knowledgebase_frontend_html_resources_index.md\":\"3AWZEmBN\",\"knowledgebase_frontend_html_concept_选择符.md\":\"DT6pX6nY\",\"knowledgebase_frontend_html_rule_index4.md\":\"BiTFMs9V\",\"knowledgebase_frontend_html_rule_index.md\":\"D6o99pki\",\"knowledgebase_frontend_html_rule_index5.md\":\"sz2y-AD_\",\"knowledgebase_frontend_html_concept_index.md\":\"DHmjtURk\",\"knowledgebase_frontend_html_concept_index5.md\":\"DsDf1DWv\",\"knowledgebase_frontend_html_rule_index3.md\":\"DSY0ergB\",\"knowledgebase_database_index.md\":\"CsP2elmT\",\"knowledgebase_frontend_html_rule_index2.md\":\"B_0z_Y-e\",\"knowledgebase_frontend_html_index.md\":\"KIvsiGWs\",\"knowledgebase_frontend_html_concept_index3.md\":\"D2-x9mUT\",\"knowledgebase_frontend_html_concept_index4.md\":\"Btzb12Gd\",\"knowledgebase_frontend_css_concept_attribute_双飞翼布局.md\":\"Do5FO078\",\"knowledgebase_frontend_html_attribute_index5.md\":\"DdTMqkwu\",\"knowledgebase_frontend_html_attribute_index4.md\":\"D84Cz8G_\",\"knowledgebase_frontend_html_attribute_index.md\":\"Db9UvzdT\",\"knowledgebase_frontend_css_application_双飞翼布局.md\":\"BRk_m0BA\",\"knowledgebase_frontend_css_application_ grid 布局配合 clip-path 实现 gta5 封面.md\":\"CDA6BoCd\",\"knowledgebase_frontend_css_index.md\":\"BT9IHq4P\",\"knowledgebase_frontend_javascript_basic-concept_data-types_类型检测.md\":\"DJ_-Q_bF\",\"knowledgebase_frontend_css_concept_concept_选择符.md\":\"DOH8-v1-\",\"knowledgebase_frontend_html_attribute_index3.md\":\"DzLKqBv7\",\"knowledgebase_frontend_css_concept_concept_取值与单位.md\":\"3ACUYeWz\",\"knowledgebase_frontend_html_attribute_选择符.md\":\"CPkhgSSO\",\"knowledgebase_frontend_javascript_basic-concept_data-types_数据类型.md\":\"DclUIppz\",\"essay_前端npm常用命令总结.md\":\"BbATKSAy\",\"knowledgebase_frontend_javascript_basic-concept_expressions_字面量.md\":\"CT6aCVsa\",\"knowledgebase_frontend_javascript_basic-concept_expressions_对象初始化表达式.md\":\"tt_sm9ML\",\"knowledgebase_frontend_javascript_basic-concept_expressions_属性访问器.md\":\"Cn6tumnu\",\"knowledgebase_frontend_javascript_basic-concept_data-types_类型转换.md\":\"wqa4ukTw\",\"knowledgebase_frontend_javascript_basic-concept_data-types_词法语法.md\":\"7blj30Pf\",\"knowledgebase_frontend_javascript_basic-concept_expressions_数组初始化表达式.md\":\"CoHsnNv5\",\"knowledgebase_frontend_javascript_basic-concept_基本语法.md\":\"DItD8P2p\",\"knowledgebase_frontend_javascript_browser-object-model_index.md\":\"CMtUEg5a\",\"knowledgebase_frontend_javascript_computer-networks_architecture_computer-networks.md\":\"RDW9t-ee\",\"knowledgebase_frontend_javascript_computer-networks_architecture_cdn.md\":\"CB4i6sVP\",\"knowledgebase_frontend_javascript_computer-networks_architecture_hls.md\":\"DYD1u4qB\",\"knowledgebase_frontend_javascript_computer-networks_architecture_dns.md\":\"BP0L3aoF\",\"knowledgebase_frontend_javascript_computer-networks_architecture_network-layer-and-data-link-layer-protocol.md\":\"Cx8eCpsp\",\"knowledgebase_frontend_javascript_computer-networks_architecture_transport-layer-protocol.md\":\"DB907wM3\",\"knowledgebase_frontend_javascript_computer-networks_http_http cors 跨域资源共享.md\":\"DlkS7nze\",\"knowledgebase_frontend_javascript_computer-networks_http_http csp 内容安全策略.md\":\"B4yB0tT2\",\"knowledgebase_frontend_javascript_computer-networks_http_http 内容协商.md\":\"DzLc20C7\",\"knowledgebase_frontend_javascript_computer-networks_http_http 状态码.md\":\"DfVCKABh\",\"knowledgebase_frontend_javascript_computer-networks_http_http 报文格式.md\":\"DKdnXVJH\",\"knowledgebase_frontend_javascript_computer-networks_http_http 连接.md\":\"O4YbVCSG\",\"knowledgebase_frontend_javascript_computer-networks_http_http 资源标识.md\":\"BAGEDSDr\",\"knowledgebase_frontend_javascript_computer-networks_http_http.md\":\"DsurQXMi\",\"knowledgebase_frontend_javascript_computer-networks_http_http 首部字段.md\":\"Ck3JU8lg\",\"knowledgebase_frontend_javascript_computer-networks_http_http2.md\":\"CEiWrZB_\",\"knowledgebase_frontend_javascript_computer-networks_http_http3.md\":\"B7hcUyFV\",\"knowledgebase_frontend_javascript_computer-networks_web-security_csrf 跨站请求伪造攻击.md\":\"CKndKNY9\",\"knowledgebase_frontend_javascript_computer-networks_http_https.md\":\"BBY9yzLW\",\"knowledgebase_frontend_javascript_computer-networks_web-security_sql 注入攻击.md\":\"fbnFdjV5\",\"knowledgebase_frontend_javascript_computer-networks_web-security_ddos 攻击.md\":\"rQnPGMtU\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_中介者模式.md\":\"CdZTNhBF\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_命令模式.md\":\"CHR9etJZ\",\"knowledgebase_frontend_javascript_computer-networks_web-security_xss 跨站脚本攻击.md\":\"DBmYy2hJ\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_模版方法模式.md\":\"DEnEH1t1\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_状态模式.md\":\"D301zRiV\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_备忘录模式.md\":\"C8d6cObv\",\"knowledgebase_frontend_javascript_core-modules_index.md\":\"BcE52o5i\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_策略模式.md\":\"CWCnf8lq\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_访问者模式.md\":\"D6F7hkcy\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_职责链模式.md\":\"CIiVDJxn\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_解释器模式.md\":\"KXg5XYSi\",\"knowledgebase_frontend_javascript_computer-networks_web-security_同源策略.md\":\"BzXjidbl\",\"knowledgebase_frontend_javascript_computer-networks_web-security_流量劫持.md\":\"BmRF1VmE\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_迭代器模式.md\":\"B4sq9952\",\"knowledgebase_frontend_javascript_design-patterns_behavioral_观察者模式.md\":\"C8yoPe2W\",\"knowledgebase_frontend_javascript_design-patterns_creational_单例模式.md\":\"BMUF0Ylb\",\"knowledgebase_frontend_javascript_design-patterns_creational_原型模式.md\":\"B9Tyw_Po\",\"knowledgebase_frontend_javascript_design-patterns_creational_工厂方法模式.md\":\"lxtnUmLW\",\"knowledgebase_frontend_javascript_design-patterns_creational_抽象工厂模式.md\":\"Bb-nCSOd\",\"knowledgebase_frontend_javascript_design-patterns_structual_代理模式.md\":\"dmfpQf48\",\"knowledgebase_frontend_javascript_design-patterns_structual_享元模式.md\":\"RajI4Zaw\",\"knowledgebase_frontend_javascript_design-patterns_structual_外观模式.md\":\"VwV5TwkV\",\"knowledgebase_frontend_javascript_design-patterns_structual_桥接模式.md\":\"BbB9PDnA\",\"knowledgebase_frontend_javascript_design-patterns_structual_组合模式.md\":\"elgojjIV\",\"knowledgebase_frontend_javascript_design-patterns_structual_装饰者模式.md\":\"B9d3WHKI\",\"knowledgebase_frontend_javascript_design-patterns_structual_适配器模式.md\":\"DiVr3b8l\",\"knowledgebase_frontend_javascript_object-oriented-programming_index.md\":\"DPPTgb7U\",\"knowledgebase_frontend_index.md\":\"B-P5fG7q\",\"knowledgebase_frontend_javascript_index.md\":\"0ViElHJE\",\"knowledgebase_frontend_javascript_document-object-model_index.md\":\"BWiXjuYJ\",\"knowledgebase_frontend_javascript_standard-built-in-objects_index.md\":\"Buo2lSJV\",\"knowledgebase_move_index.md\":\"k4nJurIu\",\"knowledgebase_other_index.md\":\"ADa-kDMu\",\"knowledgebase_move_desktop_index.md\":\"BW6IaCyG\",\"knowledgebase_move_harmony_index.md\":\"kbUm5cFH\",\"knowledgebase_move_ios_index.md\":\"Bf4TgvvP\",\"knowledgebase_move_miniprogram_index.md\":\"BmYTC9Cs\",\"knowledgebase_frontend_typescript_index.md\":\"cuZj6GaZ\",\"knowledgebase_move_android_index.md\":\"SmjlQ2bj\",\"knowledgebase_move_reactnative_index.md\":\"BrKnzzUq\",\"knowledgebase_index.md\":\"58EZHktJ\",\"knowledgebase_move_flutter_index.md\":\"D0_setD8\",\"tools_environment_index.md\":\"B8bNfevU\",\"tools_plug_index.md\":\"DVHIb40l\",\"knowledgebase_frontend_javascript_design-patterns_设计思想与原则.md\":\"DvxAIUcS\",\"index1.md\":\"C0duOv4L\",\"tools_programming_vscode.md\":\"BZPAarVt\",\"index.md\":\"DL1-dNSz\",\"tools_efficiency_index.md\":\"TlZ0vaZ9\",\"navigation_index.md\":\"OKMV3Xlk\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Mr焦\",\"description\":\"此个人博客是一个专注于IT技术学习交流的个人技术博客网站,包括敏捷开发、自动化测试、网站开发、服务器运维等领域，创建该个人博客也是为了方便与志同道合的朋友一起互相学习交流，分享经验，感谢大家的支持。\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"https://img.mtsws.cn/LightPicture/2023/08/8b794e021120837b.png\",\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}},\"returnToTopLabel\":\"返回顶部\",\"lastUpdated\":{\"text\":\"最后更新于\",\"formatOptions\":{\"dateStyle\":\"short\",\"timeStyle\":\"medium\"}},\"outline\":{\"level\":[2,6],\"label\":\"当前页大纲\"},\"outlineTitle\":\"目录\",\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"editLink\":{\"pattern\":\"https://github.com/jiaoxiaoyuan/code-docs-me/edit/master/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>